<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Health Check Dashboard</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --line:#1f2937; }
      body { background: var(--bg); color: #e2e8f0; }
      .card { background: var(--card); border: 1px solid var(--line); }
      .muted { color: var(--muted); }
      .badge-up { background-color:#16a34a; }
      .badge-down { background-color:#dc2626; }
      a { color:#93c5fd; }
      .btn-outline-danger { --bs-btn-color:#ef4444; --bs-btn-border-color:#ef4444; }
    </style>
  </head>

  <body class="p-3 p-md-4">
    <div class="container">

      <!-- Header -->
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <h1 class="h3 m-0">
          <span id="global-dot" class="me-2">●</span>
          Health Check Dashboard
        </h1>
        <div class="text-end">
          <div class="muted">מתעדכן אוטומטית כל 10 שניות</div>
          <div id="summary" class="fw-semibold mt-1"></div>
        </div>
      </div>

      <!-- Add Site Form -->
      <div class="card shadow-sm rounded-3 mb-3">
        <div class="card-body">
          <form action="/add-site" method="POST" class="row g-2 align-items-center">
            <div class="col-md-9">
              <input type="url" name="site" class="form-control" placeholder="הכנס URL (כולל https:// או דומיין)" required>
            </div>
            <div class="col-md-3 d-grid">
              <button type="submit" class="btn btn-primary">הוסף אתר</button>
            </div>
          </form>
          <div class="small muted mt-2">לדוגמה: <code>https://example.com</code> או <code>example.com</code></div>
        </div>
      </div>

      <!-- Results Table -->
      <div class="card shadow-sm rounded-3 mb-4">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle" id="results-table">
              <thead>
                <tr>
                  <th>אתר</th>
                  <th>מצב</th>
                  <th>זמן תגובה (ms)</th>
                  <th>בדיקה אחרונה</th>
                  <th>פעולות</th>
                </tr>
              </thead>
              <tbody>
                {% for row in results %}
                <tr>
                  <td><a href="{{ row.site }}" target="_blank">{{ row.site }}</a></td>
                  <td>
                    {% if row.status == "UP" %}
                      <span class="badge badge-up">UP</span>
                    {% else %}
                      <span class="badge badge-down">DOWN</span>
                    {% endif %}
                  </td>
                  <td>{{ row.response_time_ms }}</td>
                  <td class="muted">עכשיו</td>
                  <td>
                    <form action="/remove-site" method="POST" onsubmit="return confirm('למחוק את {{ row.site }}?')" style="display:inline">
                      <input type="hidden" name="site" value="{{ row.site }}">
                      <button class="btn btn-sm btn-outline-danger">מחק</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="mt-3 small muted">
            API: <code>/api</code>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card shadow-sm rounded-3">
        <div class="card-body">
          <h2 class="h5 mb-3">זמני תגובה (חי)</h2>
          <canvas id="rtChart" height="120"></canvas>
          <div class="small muted mt-2">נשמרות ~12 נקודות אחרונות לכל אתר</div>
        </div>
      </div>
    </div>

    <!-- ה-easter egg -->
    <div style="position: fixed; bottom: 5px; right: 10px; font-size: 0.8rem; opacity: 0.1; color: #e2e8f0;">
      please hire me 🙃
    </div>

    <script>
      // נתוני התחלה מהשרת
      const initialRows = {{ results|tojson }};
      const initialUp = {{ summary.up }};
      const initialTotal = {{ summary.total }};
      const sites = {{ sites|tojson }};

      const summaryEl = document.getElementById('summary');
      const dotEl = document.getElementById('global-dot');

      function renderTable(rows) {
        const tbody = document.querySelector('#results-table tbody');
        tbody.innerHTML = '';
        const nowLabel = new Date().toLocaleTimeString();

        rows.forEach(row => {
          const tr = document.createElement('tr');

          const tdSite = document.createElement('td');
          const a = document.createElement('a');
          a.href = row.site; a.target = '_blank'; a.textContent = row.site;
          tdSite.appendChild(a);

          const tdStatus = document.createElement('td');
          const badge = document.createElement('span');
          badge.className = 'badge ' + (row.status === 'UP' ? 'badge-up' : 'badge-down');
          badge.textContent = row.status;
          tdStatus.appendChild(badge);

          const tdRT = document.createElement('td');
          tdRT.textContent = row.response_time_ms;

          const tdWhen = document.createElement('td');
          tdWhen.className = 'muted';
          tdWhen.textContent = nowLabel;

          const tdActions = document.createElement('td');
          const form = document.createElement('form');
          form.action = '/remove-site';
          form.method = 'POST';
          form.onsubmit = () => confirm(`למחוק את ${row.site}?`);
          form.style.display = 'inline';

          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = 'site';
          hidden.value = row.site;

          const btn = document.createElement('button');
          btn.className = 'btn btn-sm btn-outline-danger';
          btn.textContent = 'מחק';

          form.appendChild(hidden);
          form.appendChild(btn);
          tdActions.appendChild(form);

          tr.appendChild(tdSite);
          tr.appendChild(tdStatus);
          tr.appendChild(tdRT);
          tr.appendChild(tdWhen);
          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });
      }

      function renderSummary(up, total) {
        summaryEl.textContent = `${up} מתוך ${total} אתרים פעילים`;
        dotEl.style.color = up === total ? '#16a34a' : '#dc2626';
      }

      // Chart.js
      const colors = ['#60a5fa', '#34d399', '#fbbf24', '#f472b6', '#a78bfa', '#f87171', '#38bdf8', '#22d3ee'];
      const ctx = document.getElementById('rtChart');
      const datasets = sites.map((s, i) => ({
        label: s,
        data: [],
        borderColor: colors[i % colors.length],
        tension: 0.25
      }));
      const chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets },
        options: {
          responsive: true,
          scales: {
            x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.15)' } },
            y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.15)' } }
          },
          plugins: { legend: { labels: { color: '#e2e8f0' } } }
        }
      });

      function pushChartPoint(rows) {
        const ts = new Date().toLocaleTimeString();
        chart.data.labels.push(ts);
        if (chart.data.labels.length > 12) chart.data.labels.shift();

        sites.forEach((s, i) => {
          const row = rows.find(r => r.site === s);
          const val = row ? row.response_time_ms : null;
          const arr = chart.data.datasets[i].data;
          arr.push(val);
          if (arr.length > 12) arr.shift();
        });

        chart.update();
      }

      async function refresh() {
        try {
          const res = await fetch('/api', { cache: 'no-store' });
          if (!res.ok) return;
          const data = await res.json();
          renderTable(data.results);
          renderSummary(data.summary.up, data.summary.total);
          pushChartPoint(data.results);
        } catch (e) {
          console.error('refresh error', e);
        }
      }

      // רינדור ראשון + רענון כל 10ש'
      renderTable(initialRows);
      renderSummary(initialUp, initialTotal);
      pushChartPoint(initialRows);
      setInterval(refresh, 10000);
    </script>
  </body>
</html>
